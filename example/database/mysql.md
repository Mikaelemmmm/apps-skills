# MySQL Model 示例

## user_model_gen.go - 自动生成

此文件由代码生成工具自动生成，包含基础 CRUD 操作，**请勿编辑**。

```go
// Code generated by goctl. DO NOT EDIT!

package model

import (
	"context"
	"errors"
	"fmt"

	"apps/pkg/store/mysql/gorm/gormc"
	"github.com/zeromicro/go-zero/core/stores/cache"
	"gorm.io/gorm"
	"gorm.io/plugin/soft_delete"
)

var (
	cachePlatformUserUserIdPrefix      = "cache:platformUser:user:id:"
	cachePlatformUserUserAccountPrefix = "cache:platformUser:user:account:"
	cachePlatformUserUserEmailPrefix   = "cache:platformUser:user:email:"
	cachePlatformUserUserMobilePrefix  = "cache:platformUser:user:mobile:"
)

type (
	userModel interface {
		Insert(ctx context.Context, data *User) error
		FindOne(ctx context.Context, id int64) (*User, error)
		FindOneByAccount(ctx context.Context, account string) (*User, error)
		FindOneByEmail(ctx context.Context, email string) (*User, error)
		FindOneByMobile(ctx context.Context, mobile string) (*User, error)
		Update(ctx context.Context, data *User) (int64, error)
		Delete(ctx context.Context, id int64) (int64, error)
		Transaction(ctx context.Context, fn func(ctx context.Context) error) error
	}

	defaultUserModel struct {
		gormc.CachedConn
		table string
	}

	User struct {
		Id           int64                 `gorm:"column:id"`
		Account      string                `gorm:"column:account"`
		Password     string                `gorm:"column:password"`
		Salt         string                `gorm:"column:salt"`
		Avatar       string                `gorm:"column:avatar"`
		Mobile       string                `gorm:"column:mobile"`
		Email        string                `gorm:"column:email"`
		EnableStatus int32                 `gorm:"column:enable_status"`
		Remark       string                `gorm:"column:remark"`
		CreateTime   int64                 `gorm:"column:create_time"`
		UpdateTime   int64                 `gorm:"column:update_time"`
		DeleteTime   soft_delete.DeletedAt `gorm:"column:delete_time"`
	}
)

func newUserModel(conn *gorm.DB, c cache.CacheConf) *defaultUserModel {
	return &defaultUserModel{
		CachedConn: gormc.NewConn(conn, c),
		table:      "`user`",
	}
}

// Insert 插入数据
func (m *defaultUserModel) Insert(ctx context.Context, data *User) error {
	_, err := m.ExecCtx(ctx, func(conn *gorm.DB) (int64, error) {
		result := conn.Create(&data)
		return result.RowsAffected, result.Error
	}, m.getCacheKeys(data)...)
	return err
}

// FindOne 根据 ID 查询单条数据
func (m *defaultUserModel) FindOne(ctx context.Context, id int64) (*User, error) {
	platformUserUserIdKey := fmt.Sprintf("%s%v", cachePlatformUserUserIdPrefix, id)
	var resp User
	err := m.QueryCtx(ctx, &resp, platformUserUserIdKey, func(conn *gorm.DB, v interface{}) error {
		return conn.Model(&User{}).Where("`id` = ?", id).First(&resp).Error
	})
	switch err {
	case nil:
		return &resp, nil
	case ErrNotFound:
		return nil, nil
	default:
		return nil, err
	}
}

// FindOneByAccount 根据账号查询
func (m *defaultUserModel) FindOneByAccount(ctx context.Context, account string) (*User, error) {
	platformUserUserAccountKey := fmt.Sprintf("%s%v", cachePlatformUserUserAccountPrefix, account)
	var resp User
	err := m.QueryRowIndexCtx(ctx, &resp, platformUserUserAccountKey, m.formatPrimary, func(conn *gorm.DB, v interface{}) (interface{}, error) {
		if err := conn.Model(&User{}).Where("`account` = ?", account).Take(&resp).Error; err != nil {
			return nil, err
		}
		return resp.Id, nil
	}, m.queryPrimary)
	switch err {
	case nil:
		return &resp, nil
	case ErrNotFound:
		return nil, nil
	default:
		return nil, err
	}
}

// Update 全量更新
func (m *defaultUserModel) Update(ctx context.Context, data *User) (int64, error) {
	old, err := m.FindOne(ctx, data.Id)
	if err != nil && !errors.Is(err, ErrNotFound) {
		return 0, err
	}
	rowsAffected, err := m.ExecCtx(ctx, func(conn *gorm.DB) (int64, error) {
		result := conn.Save(data)
		return result.RowsAffected, result.Error
	}, m.getCacheKeys(old)...)
	return rowsAffected, err
}

// updatePartial 局部更新（私有方法）
func (m *defaultUserModel) updatePartial(ctx context.Context, id int64, updates map[string]interface{}, where map[string]interface{}) (int64, error) {
	old, err := m.FindOne(ctx, id)
	if err != nil && !errors.Is(err, ErrNotFound) {
		return 0, err
	}
	rowsAffected, err := m.ExecCtx(ctx, func(conn *gorm.DB) (int64, error) {
		conn = conn.Where("`id` = ?", id)
		for k, v := range where {
			conn = conn.Where(fmt.Sprintf("`%s` = ?", k), v)
		}
		result := conn.Updates(updates)
		return result.RowsAffected, result.Error
	}, m.getCacheKeys(old)...)
	return rowsAffected, err
}

// Delete 删除数据
func (m *defaultUserModel) Delete(ctx context.Context, id int64) (int64, error) {
	data, err := m.FindOne(ctx, id)
	if err != nil {
		return 0, err
	}
	rowsAffected, err := m.ExecCtx(ctx, func(conn *gorm.DB) (int64, error) {
		result := conn.Delete(&User{}, id)
		return result.RowsAffected, result.Error
	}, m.getCacheKeys(data)...)
	return rowsAffected, err
}

// Transaction 事务操作
func (m *defaultUserModel) Transaction(ctx context.Context, fn func(ctx context.Context) error) error {
	return m.TransactCtx(ctx, fn)
}

// getCacheKeys 获取缓存键
func (m *defaultUserModel) getCacheKeys(data *User) []string {
	if data == nil {
		return []string{}
	}
	cacheKeys := []string{
		fmt.Sprintf("%s%v", cachePlatformUserUserIdPrefix, data.Id),
		fmt.Sprintf("%s%v", cachePlatformUserUserAccountPrefix, data.Account),
		fmt.Sprintf("%s%v", cachePlatformUserUserEmailPrefix, data.Email),
		fmt.Sprintf("%s%v", cachePlatformUserUserMobilePrefix, data.Mobile),
	}
	cacheKeys = append(cacheKeys, m.customCacheKeys(data)...)
	return cacheKeys
}
```

## user_model.go - 可扩展

在此文件中添加自定义方法、钩子函数等。

```go
//go:generate mockgen -package model -destination mock_user_model.go . UserModel
package model

import (
	"context"
	"time"

	"github.com/zeromicro/go-zero/core/stores/cache"
	"gorm.io/gorm"
)

var _ UserModel = (*customUserModel)(nil)

type (
	// UserModel 用户模型接口
	UserModel interface {
		userModel
		// 此处定义扩展方法接口
		ListUsers(ctx context.Context, page, pageSize int) ([]*User, int64, error)
		FindByMobile(ctx context.Context, mobile string) ([]*User, error)
	}

	customUserModel struct {
		*defaultUserModel
	}
)

// BeforeCreate 创建前钩子
func (u *User) BeforeCreate(db *gorm.DB) error {
	now := time.Now().Unix()
	u.CreateTime = now
	u.UpdateTime = now
	return nil
}

// BeforeUpdate 更新前钩子
func (u *User) BeforeUpdate(db *gorm.DB) error {
	u.UpdateTime = time.Now().Unix()
	return nil
}

// NewUserModel 创建用户模型
func NewUserModel(conn *gorm.DB, c cache.CacheConf) UserModel {
	return &customUserModel{
		defaultUserModel: newUserModel(conn, c),
	}
}

// ListUsers 分页查询用户列表（扩展方法示例）
func (m *customUserModel) ListUsers(ctx context.Context, page, pageSize int) ([]*User, int64, error) {
	var users []*User
	var total int64

	offset := (page - 1) * pageSize

	// 查询总数
	if err := m.DB.WithContext(ctx).Model(&User{}).Count(&total).Error; err != nil {
		return nil, 0, err
	}

	// 查询列表
	if err := m.DB.WithContext(ctx).
		Offset(offset).
		Limit(pageSize).
		Order("`id` DESC").
		Find(&users).Error; err != nil {
		return nil, 0, err
	}

	return users, total, nil
}

// FindByMobile 根据手机号查询用户（扩展方法示例）
func (m *customUserModel) FindByMobile(ctx context.Context, mobile string) ([]*User, error) {
	var users []*User
	err := m.DB.WithContext(ctx).
		Where("`mobile` = ?", mobile).
		Find(&users).Error
	return users, err
}

// UpdateMobile 更新手机号（局部更新示例）
func (m *customUserModel) UpdateMobile(ctx context.Context, userID int64, mobile string) error {
	return m.updatePartial(ctx, userID, map[string]interface{}{
		"mobile": mobile,
	}, map[string]interface{}{})
}

// customCacheKeys 自定义缓存键（如有需要）
func (m *defaultUserModel) customCacheKeys(data *User) []string {
	if data == nil {
		return []string{}
	}
	// 如需添加自定义缓存键，在此处实现
	return []string{}
}
```

## 字段说明

| 字段 | 类型 | 说明 |
|-----|------|------|
| `Id` | int64 | 主键 |
| `Account` | string | 账号 |
| `Password` | string | 密码（加密存储） |
| `Salt` | string | 密码盐值 |
| `Avatar` | string | 头像 URL |
| `Mobile` | string | 手机号 |
| `Email` | string | 邮箱 |
| `EnableStatus` | int32 | 启用状态（1=开启 2=禁用） |
| `Remark` | string | 备注 |
| `CreateTime` | int64 | 创建时间（秒级时间戳） |
| `UpdateTime` | int64 | 更新时间（秒级时间戳） |
| `DeleteTime` | soft_delete.DeletedAt | 软删除时间 |
